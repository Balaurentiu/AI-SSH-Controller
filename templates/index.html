<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Agent Controller</title>
</head>
<body>
{% extends "layout.html" %}

{% block content %}
<div class="column column-left">
    <div class="section">
        <h2>Objective</h2>
        <textarea id="objective-textarea" placeholder="Enter your high-level objective here..."></textarea>
        <div style="margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px 20px; color: #c0c0c0; background-color: #1e1e1e; padding: 10px; border-radius: 4px; border: 1px solid #444;">
            <strong style="grid-column: 1 / 2;">Execution:</strong>
            <strong style="grid-column: 2 / 3;">Summarization:</strong>
            <label style="cursor: pointer;"><input type="radio" name="execution_mode" value="independent" checked> Independent</label>
            <label style="cursor: pointer;"><input type="radio" name="summarization_mode" value="automatic" checked> Automatic</label>
            <label style="cursor: pointer;"><input type="radio" name="execution_mode" value="assisted"> Assisted</label>
            <label style="cursor: pointer;"><input type="radio" name="summarization_mode" value="assisted"> Assisted</label>
        </div>
        <div class="controls">
            <button id="execute-button">Execute Task</button>
            <button id="pause-button" style="display: none; background-color: #e67e22;">Pause</button>
            <button id="stop-button" style="display: none; background-color: #c0392b;">Stop Task</button>
        </div>
    </div>
    <div class="section is-flexible">
        <h2>Agent Execution Log (Live)</h2>
        <textarea id="log-textarea" readonly></textarea>
    </div>
</div>
<div class="column column-right">
    <div class="section is-flexible">
        <h2>Remote System Screen (Live)</h2>
        <textarea id="vm-textarea" readonly></textarea>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const executeButton = document.getElementById('execute-button');
    const stopButton = document.getElementById('stop-button');
    const pauseButton = document.getElementById('pause-button');
    const objectiveTextarea = document.getElementById('objective-textarea');
    const logTextarea = document.getElementById('log-textarea');
    const vmTextarea = document.getElementById('vm-textarea');
    const executionModeRadios = document.querySelectorAll('input[name="execution_mode"]');
    const summarizationModeRadios = document.querySelectorAll('input[name="summarization_mode"]');

    const setRadiosDisabled = (radios, disabled) => {
        radios.forEach(radio => {
            radio.disabled = disabled;
            radio.parentElement.style.color = disabled ? '#666' : '#c0c0c0';
            radio.parentElement.style.cursor = disabled ? 'not-allowed' : 'pointer';
        });
    };

    // Load saved settings from sessionStorage
    const savedExecMode = sessionStorage.getItem('executionMode');
    if (savedExecMode) {
        document.querySelector(`input[name="execution_mode"][value="${savedExecMode}"]`).checked = true;
    }
    const savedSummMode = sessionStorage.getItem('summarizationMode');
    if (savedSummMode) {
        document.querySelector(`input[name="summarization_mode"][value="${savedSummMode}"]`).checked = true;
    }

    executionModeRadios.forEach(radio => {
        radio.addEventListener('change', (e) => {
            const newMode = e.target.value;
            sessionStorage.setItem('executionMode', newMode);
            if (pauseButton.style.display === 'block' && pauseButton.textContent === 'Resume') {
                 socket.emit('update_execution_mode', { mode: newMode });
            }
        });
    });

    summarizationModeRadios.forEach(radio => {
        radio.addEventListener('change', (e) => {
            sessionStorage.setItem('summarizationMode', e.target.value);
        });
    });

    const savedObjective = sessionStorage.getItem('savedObjective');
    if (savedObjective) {
        objectiveTextarea.value = savedObjective;
    }
    objectiveTextarea.addEventListener('input', () => {
        sessionStorage.setItem('savedObjective', objectiveTextarea.value);
    });

    const appendAndScroll = (textarea, text) => {
        if (text === null || text === undefined) return;
        textarea.value += text;
        textarea.scrollTop = textarea.scrollHeight;
    };

    executeButton.onclick = () => {
        if (objectiveTextarea.value.trim() === "") {
            openModal('objective-empty');
            return;
        }
        const selectedExecMode = document.querySelector('input[name="execution_mode"]:checked').value;
        const selectedSummMode = document.querySelector('input[name="summarization_mode"]:checked').value;
        socket.emit('execute_task', {
            data: objectiveTextarea.value,
            mode: selectedExecMode,
            summarization_mode: selectedSummMode
        });
    };

    stopButton.onclick = () => {
        socket.emit('stop_task');
        closeModal('approval');
        closeModal('rejection');
    };

    pauseButton.onclick = () => {
        if (pauseButton.textContent === 'Pause') {
            socket.emit('pause_task');
        } else {
            socket.emit('resume_task', {data: objectiveTextarea.value});
        }
    };

    socket.on('agent_log', msg => {
        if (logTextarea) appendAndScroll(logTextarea, msg.data + '\n');
    });

    socket.on('vm_screen', msg => {
        if (vmTextarea) {
            if (msg.clear === true) {
                vmTextarea.value = msg.data || "";
            } else {
                appendAndScroll(vmTextarea, msg.data);
            }
        }
    });

    socket.on('task_started', () => {
        executeButton.style.display = 'none';
        stopButton.style.display = 'block';
        pauseButton.style.display = 'block';
        pauseButton.textContent = 'Pause';
        objectiveTextarea.disabled = true;
        setRadiosDisabled(executionModeRadios, true);
        setRadiosDisabled(summarizationModeRadios, true);
    });

    socket.on('task_finished', () => {
        executeButton.style.display = 'block';
        stopButton.style.display = 'none';
        pauseButton.style.display = 'none';
        objectiveTextarea.disabled = false;
        setRadiosDisabled(executionModeRadios, false);
        setRadiosDisabled(summarizationModeRadios, false);
        closeModal('approval');
        closeModal('rejection');
    });

    socket.on('task_paused', () => {
        pauseButton.textContent = 'Resume';
        pauseButton.style.backgroundColor = '#2ecc71';
        objectiveTextarea.disabled = false;
        setRadiosDisabled(executionModeRadios, false);
        setRadiosDisabled(summarizationModeRadios, false); // Allow changes during pause
    });

    socket.on('task_resumed', () => {
        pauseButton.textContent = 'Pause';
        pauseButton.style.backgroundColor = '#e67e22';
        objectiveTextarea.disabled = true;
        setRadiosDisabled(executionModeRadios, true);
        setRadiosDisabled(summarizationModeRadios, true);
    });

    socket.on('initial_state', (data) => {
        if(logTextarea) logTextarea.value = data.last_log;
        if(vmTextarea) vmTextarea.value = data.vm_output;
        
        const isPaused = data.task_running && data.task_paused;
        const isRunning = data.task_running && !data.task_paused;

        if (data.task_running) {
            executeButton.style.display = 'none';
            stopButton.style.display = 'block';
            pauseButton.style.display = 'block';
            objectiveTextarea.disabled = isRunning;
            setRadiosDisabled(executionModeRadios, isRunning);
            setRadiosDisabled(summarizationModeRadios, isRunning);
            
            if (isPaused) {
                pauseButton.textContent = 'Resume';
                pauseButton.style.backgroundColor = '#2ecc71';
            } else {
                pauseButton.textContent = 'Pause';
                pauseButton.style.backgroundColor = '#e67e22';
            }
        } else {
            executeButton.style.display = 'block';
            stopButton.style.display = 'none';
            pauseButton.style.display = 'none';
            objectiveTextarea.disabled = false;
            setRadiosDisabled(executionModeRadios, false);
            setRadiosDisabled(summarizationModeRadios, false);
        }
    });
});
</script>
{% endblock %}
</body>
</html>

