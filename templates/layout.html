<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Agent Controller</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        html, body { height: 100%; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #121212; color: #e0e0e0; }
        body { display: flex; flex-direction: column; }
        nav { padding: 10px 20px; border-bottom: 1px solid #444; background-color: #1e1e1e; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
        .nav-links a { color: #7aa5d2; text-decoration: none; font-size: 18px; margin-right: 20px; }
        .nav-links a:hover, .nav-links a.active { text-decoration: underline; color: #fff; }
        .nav-actions { display: flex; gap: 10px; align-items: center; }
        .nav-button { padding: 6px 12px; font-size: 14px; line-height: 1.5; border-radius: 4px; cursor: pointer; border: 1px solid #555; color: #d4d4d4; margin: 0; background-color: transparent; text-decoration: none; }
        #save-session-btn { background-color: #5a3e85; }
        .load-session-label { background-color: #6c757d; }
        input[type="file"].hidden-file-input { display: none; }
        .settings-bar { background-color: #2a2a2d; padding: 5px 20px; border-bottom: 1px solid #444; display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
        .config-trigger { border: 1px solid #444; border-radius: 5px; padding: 2px 15px; cursor: pointer; background-color: #3a3a3d; min-width: 240px; width: auto; flex-shrink: 0; transition: background-color 0.2s; }
        .config-trigger:hover { background-color: #4a4a4d; }
        .config-trigger.disabled { opacity: 0.5; cursor: not-allowed; background-color: #333; }
        .config-trigger.failure .summary-text, .config-trigger.failure h3 { color: #e57373; }
        .config-trigger.success .summary-text { color: #81c784; }
        .config-trigger h3 { margin: 5px 0; font-size: 14px; color: #7aa5d2; }
        .config-trigger .summary-text { font-size: 12px; color: #c0c0c0; font-family: monospace; min-height: 14px; }
        /* Updated Z-Index to 20000+ to ensure they appear ABOVE fullscreen views (which are 9999) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 20000; display: none; }
        .modal-overlay.active { display: block; }
        .modal-content { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #2a2a2d; padding: 20px; border-radius: 8px; border: 1px solid #444; z-index: 20001; display: none; max-width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .modal-content.active { display: block; }
        #agent-modal { min-width: 650px; }
        #system-modal { min-width: 800px; width: auto }
        #raw-llm-modal { width: 70vw; height: 60vh; max-width: 1200px; /* display controlled by .active */ flex-direction: column; resize: both; overflow: auto; }
        #raw-llm-modal.active { display: flex; }
        #raw-llm-textarea { height: 100%; }
        #prompt-editor-modal, #summarization-prompt-modal, #validator-prompt-modal { width: 80vw; max-width: 1400px; height: 80vh; /* display controlled by .active */ flex-direction: column; }
        #prompt-editor-modal.active, #summarization-prompt-modal.active, #validator-prompt-modal.active { display: flex; }
        #summarization-decision-modal { width: 500px; }
        .prompt-editor-container { display: flex; gap: 20px; flex-grow: 1; min-height: 0; }
        .prompt-section { display: flex; flex-direction: column; flex: 1; }
        .prompt-section label { margin-bottom: 10px; font-weight: bold; color: #aaa; }
        .prompt-section textarea { height: 100%; }
        .prompt-footer { margin-top: 15px; border-top: 1px solid #444; padding-top: 10px; flex-shrink: 0; }
        .validation-note { font-size: 12px; color: #aaa; margin: 0 0 10px; }
        .validation-note code { background-color: #1e1e1e; padding: 2px 4px; border-radius: 3px; }
        .footer-controls { display: flex; justify-content: flex-end; align-items: center; gap: 15px; }
        #save-prompts-btn, #save-validator-prompts-btn { width: auto; background-color: #4CAF50; }
        .modal-content h2 { margin: 0 0 20px 0; color: #7aa5d2; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .modal-close-btn { position: absolute; top: 15px; right: 20px; font-size: 28px; color: #aaa; cursor: pointer; line-height: 1; }
        .modal-close-btn:hover { color: #fff; }
        .modal-fieldset { border: none; padding: 0; display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px 20px; }
        .settings-item { display: flex; flex-direction: column; }
        .settings-item.full-width { grid-column: 1 / -1; }
        .settings-item.with-button { flex-direction: row; align-items: flex-end; gap: 10px; }
        .settings-item.with-button > div { flex-grow: 1; }
        .settings-item label { font-size: 14px; margin-bottom: 5px; color: #aaa; }
        .settings-item input, .settings-item select { background-color: #1e1e1e; color: #d4d4d4; border: 1px solid #555; border-radius: 4px; padding: 8px; font-family: monospace; box-sizing: border-box; width: 100%; }
        .status-label { font-size: 12px; height: 14px; margin-bottom: 5px; color: #aaa; font-family: monospace; }
        .status-label.failure { color: #e57373; }
        .status-label.success { color: #81c784; }
        .settings-item button { padding: 8px 15px; font-size: 14px; width: auto; margin-top: 0; border-radius: 4px; cursor: pointer; text-align: center; }
        #save-agent-btn { background-color: #0e639c; }
        #fetch-models-btn { background-color: #7a57d1; }
        #save-system-btn { background-color: #2d6a4f; }
        #delete-connection-btn { background-color: #9c0e35; width: auto; padding: 8px 10px; }
        .content { display: flex; flex-grow: 1; min-height: 0; }
        .column { padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        .column-left { flex: 1; min-width: 300px; }
        .column-right { flex: 2; }

        /* Fullscreen chat mode */
        #main-left-column.fullscreen-chat-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            background-color: #1e1e1e;
            padding: 0;
        }
        #main-left-column.fullscreen-chat-mode + .column-right {
            display: none;
        }

        .section { display: flex; flex-direction: column; min-height: 0; }
        .section.is-flexible { flex-grow: 1; }
        h2 { color: #7aa5d2; border-bottom: 1px solid #444; padding-bottom: 10px; margin: 0 0 10px 0; flex-shrink: 0; }
        textarea { width: 100%; flex-grow: 1; box-sizing: border-box; background-color: #1e1e1e; color: #d4d4d4; border: 1px solid #555; padding: 10px; font-family: "Consolas", monospace; font-size: 14px; border-radius: 4px; resize: none; }
        #objective-textarea { height: 100px; flex-grow: 0; }
        button { width: 100%; box-sizing: border-box; background-color: #0e639c; color: #d4d4d4; border: 1px solid #555; padding: 10px; font-size: 16px; border-radius: 4px; cursor: pointer; margin-top: 10px; }
        .controls { display: flex; gap: 10px; }
        #ask-reason-text, #ask-question-text { background-color: #1e1e1e; border: 1px solid #444; padding: 10px; border-radius: 4px; margin: 0; font-family: monospace; color: #d4d4d4; white-space: pre-wrap; word-wrap: break-word; min-height: 3em; }
        #ask-objective-textarea { height: 80px; font-size: 14px; margin-bottom: 15px; }
        #ask-modal { width: 70vw; max-width: 1100px; max-height: 80vh; overflow-y: auto; }
        #ask-modal.active { display: flex; flex-direction: column; }
        #ask-modal > div, #ask-modal textarea { flex-shrink: 0; }

        /* Chat Bubble Styles */
        .chat-bubble {
            margin-bottom: 10px;
            padding: 10px 15px;
            border-radius: 8px;
            max-width: 85%;
            width: fit-content; /* Key fix for width */
            word-wrap: break-word;
            line-height: 1.4;
        }

        .chat-bubble.user {
            background-color: #0e639c;
            margin-left: auto; /* Pushes to right */
            border-bottom-right-radius: 2px;
        }

        .chat-bubble.agent {
            background-color: #333;
            margin-right: auto; /* Pushes to left */
            border-bottom-left-radius: 2px;
        }

        /* Textarea Styles for Chat Input */
        #chat-input {
            flex-grow: 1;
            background-color: #1e1e1e;
            color: #d4d4d4;
            border: 1px solid #555;
            padding: 10px;
            border-radius: 4px;
            resize: none; /* Prevent manual resize */
            height: 50px; /* Fixed height or auto-grow via JS */
            font-family: inherit;
            overflow-y: auto;
        }
        #chat-input:focus {
            outline: none;
            border-color: #0e639c;
        }

        /* Uniform Config Chips */
        .config-chip {
            background: #2a2a2d;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 65px; /* Force all chips to be taller */
            transition: background 0.2s, border-color 0.2s;
        }

        .config-chip:hover {
            background: #333;
            border-color: #666;
        }

        .config-chip-title {
            font-weight: bold;
            color: #fff;
            font-size: 0.9em;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .config-chip-detail {
            font-size: 0.75em;
            color: #aaa;
            line-height: 1.3;
        }

        /* --- CHAT RESIZER STYLES --- */
        #view-chat {
            display: none; /* Controlled by tab logic, flex when active */
            flex-direction: column;
            height: 100%; /* Fill entire parent column height */
            overflow: hidden; /* Prevent outer scroll */
        }

        /* --- CHAT HEADER (Fixed Top) --- */
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background-color: #252526; /* Slightly lighter than bg */
            border-bottom: 1px solid #333;
            flex-shrink: 0; /* Never shrink */
            height: 50px; /* Fixed height */
            box-sizing: border-box;
        }

        .chat-header-title {
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .chat-header-actions {
            display: flex;
            gap: 8px;
        }

        .header-btn {
            background: transparent;
            border: 1px solid #444;
            color: #aaa;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: 0.2s;
        }

        .header-btn:hover {
            background: #333;
            color: white;
        }

        /* Chat History Container - Sits below fixed header */
        #chat-history-container {
            flex: 1; /* KEY: Expands to fill all free space */
            overflow-y: auto;
            padding: 15px;
            background-color: #121212;
            min-height: 0; /* Allow flexbox to shrink if needed */
        }

        /* Ensure chat history div inside container scrolls properly */
        #chat-history {
            min-height: 100%;
        }

        /* The Draggable Handle */
        #chat-resizer-handle {
            height: 12px;
            background-color: #1e1e1e;
            border-top: 1px solid #333;
            border-bottom: 1px solid #333;
            cursor: row-resize;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0; /* Prevent handle from squishing */
            z-index: 10;
            transition: background 0.2s;
        }

        #chat-resizer-handle:hover, #chat-resizer-handle.dragging {
            background-color: #333;
        }

        /* The visual 'grip' lines in the handle */
        .resizer-grip {
            width: 40px;
            height: 4px;
            background-color: #555;
            border-radius: 2px;
        }

        /* The Input Container (Resizable) */
        #chat-input-container {
            height: 140px; /* Default Initial Height */
            min-height: 80px;
            max-height: 60vh;
            display: flex;
            flex-direction: column;
            background-color: #181818;
            border-top: 1px solid #333;
            flex-shrink: 0; /* Do not shrink automatically */
        }

        /* Wrapper for Textarea and Button (Row Layout) */
        .chat-input-wrapper {
            flex: 1; /* Fill remaining space in input container */
            display: flex;
            gap: 10px;
            padding: 10px;
            height: 100%; /* Fill parent container */
            box-sizing: border-box;
        }

        /* Textarea fills all available height */
        #chat-input {
            flex: 1;
            height: 100% !important;
            background: #111;
            color: #eee;
            border: 1px solid #444;
            border-radius: 4px;
            resize: none; /* Disable native resizer */
            padding: 10px;
            box-sizing: border-box;
            font-family: inherit;
        }

        /* Button Container - Anchors button at bottom */
        .chat-btn-container {
            display: flex;
            flex-direction: column;
            justify-content: flex-end; /* Push content to bottom */
            width: 80px;
        }

        /* Send Button - Fixed Height */
        #send-chat-btn {
            height: 40px; /* FIXED height */
            width: 100%;
            background: #2196F3;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-size: 14px;
        }

        #send-chat-btn:hover {
            background: #1976D2;
        }
    </style>
</head>
<body>
    <nav>
       <div class="nav-links"> <a href="/" id="nav-live">Live Control</a> <a href="/history" id="nav-history">History & Reports</a> </div>
        <div class="nav-actions"> <a href="/save_session" id="save-session-btn" class="nav-button">Save Session</a> <label for="load-session-input" class="nav-button load-session-label">Load Session</label> <input type="file" id="load-session-input" class="hidden-file-input" accept=".zip"> </div>
    </nav>

    <div class="settings-bar">
        <div id="agent-config-trigger" class="config-chip">
            <div class="config-chip-title">
                <i class="fa-solid fa-microchip"></i> Agent & LLM
            </div>
            <div class="config-chip-detail">
                <div id="lbl-exec-info">Loading...</div>
                <div id="lbl-chat-info">Loading...</div>
            </div>
        </div>
        <div id="system-config-trigger" class="config-chip">
            <div class="config-chip-title">
                <i class="fa-solid fa-network-wired"></i> Remote System
            </div>
            <div class="config-chip-detail" id="system-summary">{{ ssh_status.message }}</div>
        </div>
        <div id="prompts-io-trigger" class="config-chip">
            <div class="config-chip-title">
                <i class="fa-solid fa-file-export"></i> Prompts I/E
            </div>
            <div class="config-chip-detail">Import/Export all prompt templates</div>
        </div>
        <div id="prompt-editor-trigger" class="config-chip">
            <div class="config-chip-title">
                <i class="fa-solid fa-file-code"></i> Prompt Editor
            </div>
            <div class="config-chip-detail">Modify agent instruction templates</div>
        </div>
        <div id="summarization-prompt-trigger" class="config-chip">
            <div class="config-chip-title">
                <i class="fa-solid fa-compress"></i> Summarization
            </div>
            <div class="config-chip-detail">Modify LLM summarization templates</div>
        </div>
        <div id="validator-prompt-trigger" class="config-chip">
            <div class="config-chip-title">
                <i class="fa-solid fa-shield-halved"></i> Validator
            </div>
            <div class="config-chip-detail">Modify command validation templates</div>
        </div>
        <div id="manual-summarize-trigger" class="config-chip {% if llm_status.status != 'success' %}disabled{% endif %}">
            <div class="config-chip-title">
                <i class="fa-solid fa-clock-rotate-left"></i> Summarize
            </div>
            <div class="config-chip-detail">
                <div id="history-char-count">0 chars</div>
            </div>
        </div>
    </div>
    
    <div class="content"> {% block content %}{% endblock %} </div>

    <div id="objective-empty-modal-overlay" class="modal-overlay"></div>
    <div id="objective-empty-modal" class="modal-content"> <span class="modal-close-btn" data-modal-id="objective-empty">&times;</span> <h2>Objective Missing</h2> <p>Please enter an objective to begin the task.</p> <button onclick="closeModal('objective-empty')" style="width: auto;">OK</button> </div>
    <div id="reset-confirm-modal-overlay" class="modal-overlay"></div>
    <div id="reset-confirm-modal" class="modal-content"> <span class="modal-close-btn" data-modal-id="reset-confirm">&times;</span> <h2>Confirm Reset</h2> <p>Are you sure you want to reset the agent's entire memory and screen output? This cannot be undone.</p> <div style="display: flex; gap: 10px; margin-top: 20px;"> <button onclick="closeModal('reset-confirm')" style="background-color: #5c5c5c;">Cancel</button> <button onclick="socket.emit('reset_agent', {data: 'reset'}); const obj = document.getElementById('objective-textarea'); if(obj) obj.value = ''; sessionStorage.removeItem('savedObjective'); closeModal('reset-confirm');" style="background-color: #9c0e35;">Reset</button> </div> </div>
    <div id="approval-modal-overlay" class="modal-overlay" data-persistent="true"></div>
    <div id="approval-modal" class="modal-content" style="min-width: 700px; max-width: 1000px;"> <span class="modal-close-btn" data-modal-id="approval" style="display: none;">&times;</span> <h2>Command Validation Required</h2> <p style="margin-top: 10px; margin-bottom: 10px;">The agent wants to execute the following command:</p> <div style="margin: 15px 0;"> <div style="color: #aaa; margin-bottom: 5px;">Reason:</div> <div id="command-reason" style="background-color: #1e1e1e; border: 1px solid #444; padding: 10px; border-radius: 4px; margin-bottom: 10px; font-family: monospace; color: #d4d4d4; white-space: pre-wrap; word-wrap: break-word;">Loading...</div> <div style="color: #aaa; margin-bottom: 5px;">Command:</div> <input type="text" id="command-to-approve" style="background-color: #1e1e1e; border: 1px solid #444; padding: 10px; border-radius: 4px; width: 100%; box-sizing: border-box; font-family: monospace; color: #d4d4d4; margin-bottom: 10px;"> <div style="color: #aaa; margin-bottom: 5px;">Modification Reason (optional - explain why you modified the command):</div> <textarea id="command-modification-reason" placeholder="Enter reason for modification if you changed the command..." style="background-color: #1e1e1e; border: 1px solid #444; padding: 10px; border-radius: 4px; width: 100%; box-sizing: border-box; font-family: monospace; color: #d4d4d4; height: 60px; resize: vertical;"></textarea> </div> <div style="display: flex; gap: 10px;"> <button id="approve-command-btn" onclick="socket.emit('approve_command', { approved: true, command: document.getElementById('command-to-approve').value, modification_reason: document.getElementById('command-modification-reason').value}); document.getElementById('command-modification-reason').value=''; closeModal('approval');" style="background-color: #4CAF50;">Approve & Execute</button> <button onclick="showModal('rejection');" style="background-color: #FF5733;">Reject</button> </div> </div>
    <div id="rejection-modal-overlay" class="modal-overlay" data-persistent="true"></div>
    <div id="rejection-modal" class="modal-content" style="min-width: 400px;"> <span class="modal-close-btn" data-modal-id="rejection" style="display: none;">&times;</span> <h2>Provide Rejection Reason</h2> <textarea id="rejection-reason" placeholder="Enter reason for rejection..." style="width: 100%; height: 100px; margin-top: 10px;"></textarea> <button onclick="socket.emit('approve_command', { approved: false, reason: document.getElementById('rejection-reason').value}); document.getElementById('rejection-reason').value=''; closeModal('rejection'); closeModal('approval');" style="background-color: #FF5733;">Submit Rejection</button> </div>

    <!-- Enhanced Ask Modal with Stop Task button -->
    <div id="ask-modal-overlay" class="modal-overlay" data-persistent="true"></div>
    <div id="ask-modal" class="modal-content">
        <span class="modal-close-btn" data-modal-id="ask" style="display: none;">&times;</span> 
        <h2>Agent is Requesting Information</h2> 
        <p style="margin-top: 10px; margin-bottom: 10px;">The agent needs clarification:</p> 
        <div style="margin: 15px 0;"> 
            <div style="color: #aaa; margin-bottom: 5px;">Reason:</div> 
            <div id="ask-reason-text">Loading...</div> 
            <div style="color: #aaa; margin-bottom: 5px; margin-top: 15px;">Question:</div> 
            <div id="ask-question-text">Loading...</div> 
        </div> 
        <div style="margin-top: 20px;"> 
            <div style="color: #aaa; margin-bottom: 5px;">Current Objective (you can modify if needed):</div> 
            <textarea id="ask-objective-textarea">Loading...</textarea> 
            <div style="color: #aaa; margin-bottom: 5px;">Your Answer:</div> 
            <textarea id="user-answer-textarea" placeholder="Type your response here..." style="width: 100%; height: 100px;"></textarea> 
        </div> 
        <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button onclick="socket.emit('provide_answer', { answer: document.getElementById('user-answer-textarea').value, objective: document.getElementById('ask-objective-textarea').value}); document.getElementById('user-answer-textarea').value=''; closeModal('ask');" style="background-color: #4CAF50; flex: 1;">Submit Answer</button>
            <button onclick="socket.emit('stop_task'); closeModal('ask');" style="background-color: #c0392b; flex: 1;">Stop Task</button>
        </div>
    </div>
    
    <!-- Enhanced Summarization Decision Modal -->
    <div id="summarization-decision-modal-overlay" class="modal-overlay"></div>
    <div id="summarization-decision-modal" class="modal-content">
        <span class="modal-close-btn" data-modal-id="summarization-decision">&times;</span>
        <h2>History Summarization Required</h2>
        <p>The agent history has reached <span id="current-history-chars">0</span> characters.</p>
        <p>Current threshold: <span id="current-threshold-display">15000</span> characters.</p>
        <div style="margin: 20px 0;">
            <label for="new-threshold-input" style="display: block; color: #aaa; margin-bottom: 5px;">Update threshold (optional):</label>
            <input type="number" id="new-threshold-input" min="1000" max="100000" style="width: 100%; background-color: #1e1e1e; color: #d4d4d4; border: 1px solid #555; border-radius: 4px; padding: 8px;">
        </div>
        <div style="display: flex; gap: 10px;">
            <button onclick="handleSummarizationDecision(true);" style="background-color: #4CAF50; flex: 1;">Summarize Now</button>
            <button onclick="handleSummarizationDecision(false);" style="background-color: #e67e22; flex: 1;">Continue Without Summarizing</button>
        </div>
    </div>

    <!-- Action Plan Modal -->
    <div id="action-plan-modal-overlay" class="modal-overlay"></div>
    <div id="action-plan-modal" class="modal-content" style="min-width: 600px; max-width: 800px; overflow-x: hidden; box-sizing: border-box;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h2 style="margin: 0;">Action Plan Status</h2>
            <div style="display: flex; gap: 10px;">
                <button id="btn-fullscreen-plan" onclick="togglePlanFullscreen()"
                        style="background-color: #34495e; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 16px;"
                        title="Toggle Fullscreen">
                    â›¶
                </button>
                <span class="modal-close-btn" data-modal-id="action-plan" style="position: static; margin: 0; cursor: pointer;">&times;</span>
            </div>
        </div>
        <div id="action-plan-content" style="background-color: #1e1e1e; border: 1px solid #444; border-radius: 4px; padding: 15px; margin-top: 10px; font-family: monospace; color: #d4d4d4; overflow-y: auto; overflow-x: hidden; box-sizing: border-box;">
            <p style="color: #666; text-align: center;">No active action plan</p>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button onclick="closeModal('action-plan')" style="background-color: #5c5c5c; width: auto; flex: 1;">Close</button>
            <button id="btn-edit-plan" onclick="togglePlanEditMode()" style="background-color: #3498db; width: auto; flex: 1; display: none;">Edit Plan</button>
            <button id="btn-add-step" onclick="addEditStep()" style="background-color: #27ae60; width: auto; flex: 1; display: none;">+ Add Step</button>
            <button id="btn-save-plan" onclick="savePlanChanges()" style="background-color: #27ae60; width: auto; flex: 1; display: none;">Save Changes</button>
            <button id="clear-plan-btn" onclick="clearActionPlan()" style="background-color: #c0392b; width: auto; flex: 1; display: none;">Clear Plan</button>
        </div>
    </div>

    <div id="agent-modal-overlay" class="modal-overlay"></div>
    <div id="agent-modal" class="modal-content" style="min-width: 900px; max-width: 1200px;">
        <span class="modal-close-btn" data-modal-id="agent">&times;</span>
        <h2>Agent & LLM Configuration</h2>

        <!-- Dual LLM Configuration -->
        <div style="display: flex; gap: 20px; margin-bottom: 20px;">

            <!-- Execution LLM (Left Column) -->
            <div style="flex: 1; background: #252526; padding: 15px; border-radius: 4px; border: 2px solid #0e639c;">
                <h3 style="margin-top: 0; color: #7aa5d2; font-size: 16px;">Execution LLM</h3>

                <div style="margin-bottom: 15px;">
                    <label style="font-size: 14px; margin-bottom: 5px; color: #aaa; display: block;">Provider</label>
                    <select id="exec-provider" onchange="updateProviderFields('exec')" style="width: 100%; background-color: #1e1e1e; color: #d4d4d4; border: 1px solid #555; border-radius: 4px; padding: 8px; font-family: monospace;">
                        <option value="ollama">Ollama (Local)</option>
                        <option value="gemini">Gemini (Cloud)</option>
                        <option value="anthropic">Anthropic Claude (Cloud)</option>
                    </select>
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="font-size: 14px; margin-bottom: 5px; color: #aaa; display: block;">Model</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="exec-model" style="flex: 1; background-color: #1e1e1e; color: #d4d4d4; border: 1px solid #555; border-radius: 4px; padding: 8px; font-family: monospace;">
                            <option value="">-- Click Fetch to load models --</option>
                        </select>
                        <button onclick="fetchModelsForScope('exec')" style="padding: 8px 15px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap;">Fetch</button>
                    </div>
                </div>

                <div id="exec-ollama-url" style="margin-bottom: 15px;">
                    <label style="font-size: 14px; margin-bottom: 5px; color: #aaa; display: block;">Ollama API URL</label>
                    <input type="text" id="exec-ollama-url-input" value="http://localhost:11434" style="width: 100%; background-color: #1e1e1e; color: #d4d4d4; border: 1px solid #555; border-radius: 4px; padding: 8px; font-family: monospace; box-sizing: border-box;">
                </div>

                <div id="exec-gemini-key" style="margin-bottom: 15px; display: none;">
                    <label style="font-size: 14px; margin-bottom: 5px; color: #aaa; display: block;">Gemini API Key</label>
                    <input type="password" id="exec-gemini-key-input" placeholder="AIzaSy..." style="width: 100%; background-color: #1e1e1e; color: #d4d4d4; border: 1px solid #555; border-radius: 4px; padding: 8px; font-family: monospace; box-sizing: border-box;">
                </div>

                <div id="exec-anthropic-key" style="margin-bottom: 15px; display: none;">
                    <label style="font-size: 14px; margin-bottom: 5px; color: #aaa; display: block;">Anthropic API Key</label>
                    <input type="password" id="exec-anthropic-key-input" placeholder="sk-ant-..." style="width: 100%; background-color: #1e1e1e; color: #d4d4d4; border: 1px solid #555; border-radius: 4px; padding: 8px; font-family: monospace; box-sizing: border-box;">
                </div>
            </div>

            <!-- Chat LLM (Right Column) -->
            <div style="flex: 1; background: #252526; padding: 15px; border-radius: 4px; border: 2px solid #4CAF50;">
                <h3 style="margin-top: 0; color: #4CAF50; font-size: 16px;">Chat LLM</h3>

                <div style="margin-bottom: 15px;">
                    <label style="font-size: 14px; margin-bottom: 5px; color: #aaa; display: block;">Provider</label>
                    <select id="chat-provider" onchange="updateProviderFields('chat')" style="width: 100%; background-color: #1e1e1e; color: #d4d4d4; border: 1px solid #555; border-radius: 4px; padding: 8px; font-family: monospace;">
                        <option value="ollama">Ollama (Local)</option>
                        <option value="gemini">Gemini (Cloud)</option>
                        <option value="anthropic">Anthropic Claude (Cloud)</option>
                    </select>
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="font-size: 14px; margin-bottom: 5px; color: #aaa; display: block;">Model</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="chat-model" style="flex: 1; background-color: #1e1e1e; color: #d4d4d4; border: 1px solid #555; border-radius: 4px; padding: 8px; font-family: monospace;">
                            <option value="">-- Click Fetch to load models --</option>
                        </select>
                        <button onclick="fetchModelsForScope('chat')" style="padding: 8px 15px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap;">Fetch</button>
                    </div>
                </div>

                <div id="chat-ollama-url" style="margin-bottom: 15px;">
                    <label style="font-size: 14px; margin-bottom: 5px; color: #aaa; display: block;">Ollama API URL</label>
                    <input type="text" id="chat-ollama-url-input" value="http://localhost:11434" style="width: 100%; background-color: #1e1e1e; color: #d4d4d4; border: 1px solid #555; border-radius: 4px; padding: 8px; font-family: monospace; box-sizing: border-box;">
                </div>

                <div id="chat-gemini-key" style="margin-bottom: 15px; display: none;">
                    <label style="font-size: 14px; margin-bottom: 5px; color: #aaa; display: block;">Gemini API Key</label>
                    <input type="password" id="chat-gemini-key-input" placeholder="AIzaSy..." style="width: 100%; background-color: #1e1e1e; color: #d4d4d4; border: 1px solid #555; border-radius: 4px; padding: 8px; font-family: monospace; box-sizing: border-box;">
                </div>

                <div id="chat-anthropic-key" style="margin-bottom: 15px; display: none;">
                    <label style="font-size: 14px; margin-bottom: 5px; color: #aaa; display: block;">Anthropic API Key</label>
                    <input type="password" id="chat-anthropic-key-input" placeholder="sk-ant-..." style="width: 100%; background-color: #1e1e1e; color: #d4d4d4; border: 1px solid #555; border-radius: 4px; padding: 8px; font-family: monospace; box-sizing: border-box;">
                </div>
            </div>
        </div>

        <!-- Shared Settings -->
        <fieldset class="modal-fieldset">
            <div class="settings-item">
                <label for="max-steps">Max Steps:</label>
                <input type="number" id="max-steps" value="50" min="1" max="500">
            </div>
            <div class="settings-item">
                <label for="summarization-threshold">Summarization Threshold:</label>
                <input type="number" id="summarization-threshold" value="15000" min="0" max="100000">
            </div>
            <div class="settings-item">
                <label for="llm-timeout">LLM Response Timeout (seconds):</label>
                <input type="number" id="llm-timeout" value="120" min="30" max="600">
            </div>
            <div class="settings-item">
                <label for="chat-history-count">Chat History Message Count:</label>
                <input type="number" id="chat-history-count" value="20" min="0" max="100">
            </div>
        </fieldset>

        <button id="save-agent-btn">Save Agent Configuration</button>
    </div>
    
    <div id="system-modal-overlay" class="modal-overlay"></div>
    <div id="system-modal" class="modal-content"> <span class="modal-close-btn" data-modal-id="system">&times;</span> <h2>Remote System Connection</h2> <div style="display: flex; gap: 20px; align-items: flex-start;"> <div style="flex: 1;"> <h3 style="margin-top: 0; font-size: 16px; color: #7aa5d2;">Saved Connections</h3> <select id="saved-connections-select" size="6" style="width: 100%; background-color: #1e1e1e; color: #d4d4d4; border: 1px solid #555; border-radius: 4px; padding: 5px; font-family: monospace; min-height: 150px;"> <option value="">-- No saved connections --</option> </select> <div style="display: flex; gap: 10px; margin-top: 10px;"> <button id="load-connection-btn" style="background-color: #0e639c;">Load</button> <button id="delete-connection-btn">Delete</button> </div> </div> <div style="flex: 2;"> <fieldset class="modal-fieldset"> <div class="settings-item"> <label for="system-ip">System IP:</label> <div id="system-ip-status" class="status-label"></div> <input type="text" id="system-ip" placeholder="192.168.1.100"> </div> <div class="settings-item"> <label for="system-username">Username:</label> <input type="text" id="system-username" placeholder="root"> </div> <div class="settings-item"> <label for="ssh-port">SSH Port:</label> <input type="number" id="ssh-port" placeholder="22" value="22" min="1" max="65535"> </div> <div class="settings-item full-width"> <label for="ssh-key-path">SSH Key Path:</label> <input type="text" id="ssh-key-path" placeholder="/app/keys/id_rsa" readonly style="background-color: #333;"> </div> <div class="settings-item full-width with-button"> <div> <label for="deployment-password">Password (for key deployment):</label> <div id="deployment-status" class="status-label"></div> <input type="password" id="deployment-password" placeholder="Enter password to deploy SSH key"> </div> <button id="deploy-key-btn" style="background-color: #e67e22;">Deploy Key</button> </div> </fieldset> <button id="save-system-btn">Save & Test Connection</button> </div> </div> <div id="deploy-log-area" style="display: none; margin-top: 15px;"> <h3 style="font-size: 14px; color: #7aa5d2; margin-bottom: 10px;">Key Deployment Log</h3> <textarea id="deploy-log-textarea" readonly style="width: 100%; height: 100px; background-color: #1e1e1e; color: #d4d4d4; border: 1px solid #555; padding: 5px; font-family: monospace; font-size: 12px;"></textarea> </div> </div>

    <!-- Prompts Import/Export Modal -->
    <div id="prompts-io-modal-overlay" class="modal-overlay"></div>
    <div id="prompts-io-modal" class="modal-content" style="min-width: 500px; max-width: 700px;">
        <span class="modal-close-btn" data-modal-id="prompts-io">&times;</span>
        <h2>Import/Export Prompts</h2>

        <p style="color: #aaa; font-size: 14px; margin-bottom: 20px;">
            Export all prompts to a ZIP archive or import prompts from a previously saved ZIP file.
        </p>

        <!-- Export Section -->
        <fieldset class="modal-fieldset">
            <legend style="color: #7aa5d2; font-weight: bold;">Export Prompts</legend>
            <p style="color: #999; font-size: 13px; margin-bottom: 15px;">
                Download all current prompt templates as a ZIP archive containing individual text files.
            </p>
            <button id="export-prompts-btn" style="background-color: #27ae60; width: 100%; padding: 12px;">
                <i class="fa-solid fa-download"></i> Export All Prompts
            </button>
        </fieldset>

        <!-- Import Section -->
        <fieldset class="modal-fieldset" style="margin-top: 20px;">
            <legend style="color: #7aa5d2; font-weight: bold;">Import Prompts</legend>
            <p style="color: #999; font-size: 13px; margin-bottom: 15px;">
                Upload a ZIP archive to replace current prompts. Each .txt file will update the corresponding prompt template.
            </p>
            <div style="margin-bottom: 15px;">
                <label for="import-prompts-file" style="display: block; color: #aaa; margin-bottom: 8px;">
                    Select ZIP file:
                </label>
                <input type="file" id="import-prompts-file" accept=".zip"
                       style="width: 100%; padding: 8px; background-color: #1e1e1e; color: #d4d4d4; border: 1px solid #555; border-radius: 4px; cursor: pointer;">
            </div>
            <button id="import-prompts-btn" style="background-color: #3498db; width: 100%; padding: 12px;">
                <i class="fa-solid fa-upload"></i> Import Prompts from ZIP
            </button>
        </fieldset>

        <!-- Status Message -->
        <div id="prompts-io-status" style="margin-top: 20px; padding: 10px; border-radius: 4px; display: none;">
            <span id="prompts-io-status-text"></span>
        </div>
    </div>

    <div id="prompt-editor-modal-overlay" class="modal-overlay"></div>
    <div id="prompt-editor-modal" class="modal-content"> <span class="modal-close-btn" data-modal-id="prompt-editor">&times;</span> <h2>Instruction Templates</h2> <div style="display: flex; gap: 10px; margin-bottom: 15px;"> <button id="standard-mode-btn" style="flex: 1; background-color: #0e639c;">Standard Mode</button> <button id="ask-mode-btn" style="flex: 1; background-color: #5c5c5c;">Ask Mode</button> <button id="chat-mode-btn" style="flex: 1; background-color: #5c5c5c;">Chat Mode</button> </div> <div class="prompt-editor-container"> <div id="execution-prompts-container" style="display: flex; gap: 20px; flex: 1;"> <div class="prompt-section"> <label for="ollama-prompt-textarea">Ollama Template</label> <textarea id="ollama-prompt-textarea"></textarea> </div> <div class="prompt-section"> <label for="cloud-prompt-textarea">Cloud Model Template</label> <textarea id="cloud-prompt-textarea"></textarea> </div> </div> <div id="chat-prompt-container" style="display: none; flex: 1;"> <div class="prompt-section"> <label for="chat-prompt-textarea">Chat Persona & Rules Template</label> <textarea id="chat-prompt-textarea"></textarea> </div> </div> </div> <div class="prompt-footer"> <p id="prompt-validation-note" class="validation-note"> Required variables: <code>{objective}</code>, <code>{history}</code>, <code>{system_info}</code><br> Required keywords: <code>COMMAND:</code>, <code>REPORT:</code> </p> <div class="footer-controls"> <span id="prompt-validation-status" style="color: #aaa; font-size: 14px;"></span> <button id="save-prompts-btn">Save Templates</button> </div> </div> </div>
    <div id="summarization-prompt-modal-overlay" class="modal-overlay"></div>
    <div id="summarization-prompt-modal" class="modal-content" style="height: 85vh;">
        <span class="modal-close-btn" data-modal-id="summarization-prompt">&times;</span>
        <h2>Summarization Templates</h2>

        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <button id="sum-history-mode-btn" style="flex: 1; background-color: #0e639c;">History Summarization</button>
            <button id="sum-step-mode-btn" style="flex: 1; background-color: #5c5c5c;">Step Output Summarization</button>
            <button id="sum-search-mode-btn" style="flex: 1; background-color: #5c5c5c;">Search Results Summarization</button>
        </div>

        <div id="sum-history-container" style="display: flex; flex-direction: column; flex-grow: 1; min-height: 0;">
            <div class="prompt-editor-container">
                <div class="prompt-section">
                    <label for="ollama-summarize-prompt-textarea">Ollama History Template</label>
                    <textarea id="ollama-summarize-prompt-textarea"></textarea>
                </div>
                <div class="prompt-section">
                    <label for="cloud-summarize-prompt-textarea">Cloud Model History Template</label>
                    <textarea id="cloud-summarize-prompt-textarea"></textarea>
                </div>
            </div>
            <p class="validation-note" style="margin-top: 10px;">Required variable: <code>{history}</code>. Optional: <code>{objective}</code>.<br>Used when the total context size exceeds the threshold.</p>
        </div>

        <div id="sum-step-container" style="display: none; flex-direction: column; flex-grow: 1; min-height: 0;">
            <div class="prompt-editor-container">
                <div class="prompt-section">
                    <label for="ollama-step-prompt-textarea">Ollama Step Template</label>
                    <textarea id="ollama-step-prompt-textarea"></textarea>
                </div>
                <div class="prompt-section">
                    <label for="cloud-step-prompt-textarea">Cloud Model Step Template</label>
                    <textarea id="cloud-step-prompt-textarea"></textarea>
                </div>
            </div>
            <p class="validation-note" style="margin-top: 10px;">Required variable: <code>{output}</code>.<br>Used when a single command output is too large (Flood Protection).</p>
        </div>

        <div id="sum-search-container" style="display: none; flex-direction: column; flex-grow: 1; min-height: 0;">
            <div class="prompt-editor-container">
                <div class="prompt-section">
                    <label for="ollama-search-prompt-textarea">Ollama Search Template</label>
                    <textarea id="ollama-search-prompt-textarea"></textarea>
                </div>
                <div class="prompt-section">
                    <label for="cloud-search-prompt-textarea">Cloud Model Search Template</label>
                    <textarea id="cloud-search-prompt-textarea"></textarea>
                </div>
            </div>
            <p class="validation-note" style="margin-top: 10px;">Required variable: <code>{results}</code>. Optional: <code>{objective}</code>.<br>Used when summarizing search results (SRCH command).</p>
        </div>

        <div class="prompt-footer">
            <div class="footer-controls">
                <span id="summarization-validation-status" style="color: #aaa; font-size: 14px;"></span>
                <button id="save-summarization-prompts-btn">Save All Templates</button>
            </div>
        </div>
    </div>
    
    <!-- Validator Prompt Modal -->
    <div id="validator-prompt-modal-overlay" class="modal-overlay"></div>
    <div id="validator-prompt-modal" class="modal-content">
        <span class="modal-close-btn" data-modal-id="validator-prompt">&times;</span>
        <h2>Command Validator Templates</h2>
        <div class="prompt-editor-container">
            <div class="prompt-section">
                <label for="ollama-validator-prompt-textarea">Ollama Validator Template</label>
                <textarea id="ollama-validator-prompt-textarea"></textarea>
            </div>
            <div class="prompt-section">
                <label for="cloud-validator-prompt-textarea">Cloud Model Validator Template</label>
                <textarea id="cloud-validator-prompt-textarea"></textarea>
            </div>
        </div>
        <div class="prompt-footer">
            <p class="validation-note">
                Required variable: <code>{command}</code><br>
                Optional variables: <code>{system_info}</code>, <code>{sudo_available}</code>, <code>{reason}</code>, <code>{summarization_threshold}</code>, <code>{command_timeout}</code><br>
                Required response format: Must respond with <code>APPROVE</code> or <code>REJECT REASON: [reason]</code><br>
                This template is used in Independent mode to validate commands before execution.
            </p>
            <div class="footer-controls">
                <span id="validator-validation-status" style="color: #aaa; font-size: 14px;"></span>
                <button id="save-validator-prompts-btn">Save Validator Templates</button>
            </div>
        </div>
    </div>
    
    <script>
const socket = io();
function openModal(modalId) { 
    const modal = document.getElementById(modalId + '-modal');
    const overlay = document.getElementById(modalId + '-modal-overlay');
    if (!modal || !overlay) return;
    modal.classList.add('active');
    overlay.classList.add('active');
}
function closeModal(modalId) {
    const modal = document.getElementById(modalId + '-modal');
    const overlay = document.getElementById(modalId + '-modal-overlay');
    if (!modal || !overlay) return;

    // If action-plan modal is in fullscreen, exit fullscreen first
    if (modalId === 'action-plan' && window.isPlanFullscreen) {
        window.togglePlanFullscreen();
    }

    modal.classList.remove('active');
    overlay.classList.remove('active');
}
function showModal(modalId) { openModal(modalId); }

// Global function for handling summarization decision with threshold update
function handleSummarizationDecision(doSummarize) {
    const newThresholdInput = document.getElementById('new-threshold-input');
    const newThreshold = newThresholdInput.value;

    socket.emit('summarize_decision', {
        summarize: doSummarize,
        new_threshold: newThreshold ? parseInt(newThreshold) : null
    });

    closeModal('summarization-decision');
}

// --- DUAL LLM CONFIGURATION FUNCTIONS (Global scope for onclick) ---

// Helper function to set model in select dropdown (adds option if not exists)
function setModelInDropdown(selectId, modelName) {
    const selectElement = document.getElementById(selectId);
    if (!selectElement) return;

    // If model name is empty, just clear to default
    if (!modelName) {
        selectElement.innerHTML = '<option value="">-- Click Fetch to load models --</option>';
        return;
    }

    // Check if the model already exists as an option
    let optionExists = false;
    for (let i = 0; i < selectElement.options.length; i++) {
        if (selectElement.options[i].value === modelName) {
            optionExists = true;
            break;
        }
    }

    // If option doesn't exist, add it (preserving existing options)
    if (!optionExists) {
        const option = document.createElement('option');
        option.value = modelName;
        option.textContent = modelName;
        selectElement.appendChild(option);
    }

    // Set the value
    selectElement.value = modelName;
    console.log(`[setModelInDropdown] Set ${selectId} to ${modelName}`);
}

// Update provider-specific fields visibility
function updateProviderFields(scope) {
    const provider = document.getElementById(`${scope}-provider`).value;

    const ollamaUrl = document.getElementById(`${scope}-ollama-url`);
    const geminiKey = document.getElementById(`${scope}-gemini-key`);
    const anthropicKey = document.getElementById(`${scope}-anthropic-key`);

    // Hide all first
    ollamaUrl.style.display = 'none';
    geminiKey.style.display = 'none';
    anthropicKey.style.display = 'none';

    // Show relevant field
    if (provider === 'ollama') {
        ollamaUrl.style.display = 'block';
    } else if (provider === 'gemini') {
        geminiKey.style.display = 'block';
    } else if (provider === 'anthropic') {
        anthropicKey.style.display = 'block';
    }
}

// Fetch models for specific scope (exec or chat)
function fetchModelsForScope(scope) {
    const provider = document.getElementById(`${scope}-provider`).value;
    let apiKey = '';

    if (provider === 'gemini') {
        apiKey = document.getElementById(`${scope}-gemini-key-input`).value;
    } else if (provider === 'anthropic') {
        apiKey = document.getElementById(`${scope}-anthropic-key-input`).value;
    }

    console.log(`[fetchModelsForScope] Scope: ${scope}, Provider: ${provider}, API Key: ${apiKey ? '***' : '(none)'}`);

    const originalCursor = document.body.style.cursor;
    document.body.style.cursor = 'wait';

    fetch('/get_models', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            provider: provider,
            api_key: apiKey
        })
    })
    .then(res => res.json())
    .then(data => {
        document.body.style.cursor = originalCursor;

        console.log(`[fetchModelsForScope] Response for ${scope}:`, data);

        if (data.status === 'success') {
            const selectElement = document.getElementById(`${scope}-model`);
            console.log(`[fetchModelsForScope] Select element for ${scope}:`, selectElement);

            // Store currently selected value (if any)
            const currentValue = selectElement.value;
            console.log(`[fetchModelsForScope] Current value: ${currentValue}`);

            // Clear and repopulate
            selectElement.innerHTML = '';

            // Add default option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '-- Select a model --';
            selectElement.appendChild(defaultOption);

            // Add all fetched models
            data.models.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                selectElement.appendChild(option);
            });

            // Try to restore previous selection if it exists in the new list
            if (currentValue && data.models.includes(currentValue)) {
                selectElement.value = currentValue;
                console.log(`[fetchModelsForScope] Restored previous selection: ${currentValue}`);
            } else if (data.models.length > 0) {
                // If no previous selection or it's not in the list, select first model
                selectElement.value = data.models[0];
                console.log(`[fetchModelsForScope] Auto-selected first model: ${data.models[0]}`);
            }

            console.log(`[fetchModelsForScope] Populated ${data.models.length} models for ${scope}`);
            alert(`Found ${data.models.length} models for ${scope.toUpperCase()}. Select from dropdown.`);
        } else {
            console.error(`[fetchModelsForScope] Error for ${scope}:`, data.message);
            alert('Error: ' + data.message);
        }
    })
    .catch(e => {
        document.body.style.cursor = originalCursor;
        console.error(`[fetchModelsForScope] Request failed for ${scope}:`, e);
        alert('Request Failed: ' + e);
    });
}

document.addEventListener('DOMContentLoaded', () => {
    const agentTrigger = document.getElementById('agent-config-trigger');
    const systemTrigger = document.getElementById('system-config-trigger');
    const promptsIoTrigger = document.getElementById('prompts-io-trigger');
    const promptEditorTrigger = document.getElementById('prompt-editor-trigger');
    const summarizationTrigger = document.getElementById('summarization-prompt-trigger');
    const validatorTrigger = document.getElementById('validator-prompt-trigger');
    const manualSummarizeTrigger = document.getElementById('manual-summarize-trigger');
    const saveSessionBtn = document.getElementById('save-session-btn');
    const loadSessionInput = document.getElementById('load-session-input');

    document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', function() {
            // Don't close persistent modals (approval, rejection, ask) on outside click
            if (this.hasAttribute('data-persistent')) {
                return;
            }
            const modalId = this.id.replace('-modal-overlay', '');
            closeModal(modalId);
        });
    });
    document.querySelectorAll('.modal-close-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const modalId = this.getAttribute('data-modal-id');
            closeModal(modalId);
        });
    });

    // Agent & LLM configuration modal logic
    const maxSteps = document.getElementById('max-steps');
    const summarizationThreshold = document.getElementById('summarization-threshold');
    const llmTimeout = document.getElementById('llm-timeout');
    const chatHistoryCount = document.getElementById('chat-history-count');
    const saveAgentBtn = document.getElementById('save-agent-btn');

    agentTrigger.addEventListener('click', function() {
        if(this.classList.contains('disabled')) return;
        fetch('/get_agent_config').then(res => res.json()).then(data => {
            // Load Execution LLM Settings
            document.getElementById('exec-provider').value = data.provider || 'ollama';
            setModelInDropdown('exec-model', data.model_name || '');
            document.getElementById('exec-ollama-url-input').value = data.ollama_api_url || 'http://localhost:11434';
            document.getElementById('exec-gemini-key-input').value = data.gemini_api_key || '';
            document.getElementById('exec-anthropic-key-input').value = data.anthropic_api_key || '';
            updateProviderFields('exec');

            // Load Chat LLM Settings
            if (data.chat_llm) {
                document.getElementById('chat-provider').value = data.chat_llm.provider || 'ollama';
                setModelInDropdown('chat-model', data.chat_llm.model_name || '');
                document.getElementById('chat-ollama-url-input').value = data.ollama_api_url || 'http://localhost:11434';
                document.getElementById('chat-gemini-key-input').value = data.chat_llm.api_key || '';
                document.getElementById('chat-anthropic-key-input').value = data.chat_llm.api_key || '';
                updateProviderFields('chat');
            } else {
                // Default chat to same as exec
                document.getElementById('chat-provider').value = data.provider || 'ollama';
                setModelInDropdown('chat-model', data.model_name || '');
                document.getElementById('chat-ollama-url-input').value = data.ollama_api_url || 'http://localhost:11434';
                document.getElementById('chat-gemini-key-input').value = data.gemini_api_key || '';
                document.getElementById('chat-anthropic-key-input').value = data.anthropic_api_key || '';
                updateProviderFields('chat');
            }

            // Load Shared Settings
            maxSteps.value = data.max_steps;
            summarizationThreshold.value = data.summarization_threshold;
            llmTimeout.value = data.llm_timeout || 120;
            chatHistoryCount.value = data.chat_history_message_count || 20;

        }).catch(e => console.error('Error loading agent config:', e));
        openModal('agent');
    });


    // Auto-update summarization threshold when changed in Agent config
    summarizationThreshold.addEventListener('change', function() {
        socket.emit('update_summarization_threshold', {threshold: parseInt(this.value)});
    });

    saveAgentBtn.addEventListener('click', function() {
        // Get Execution LLM config
        const execProvider = document.getElementById('exec-provider').value;
        const execModel = document.getElementById('exec-model').value;
        const execOllamaUrl = document.getElementById('exec-ollama-url-input').value;
        const execGeminiKey = document.getElementById('exec-gemini-key-input').value;
        const execAnthropicKey = document.getElementById('exec-anthropic-key-input').value;

        // Get Chat LLM config
        const chatProvider = document.getElementById('chat-provider').value;
        const chatModel = document.getElementById('chat-model').value;
        let chatApiKey = '';
        if (chatProvider === 'gemini') {
            chatApiKey = document.getElementById('chat-gemini-key-input').value;
        } else if (chatProvider === 'anthropic') {
            chatApiKey = document.getElementById('chat-anthropic-key-input').value;
        }

        const config = {
            provider: execProvider,
            model_name: execModel,
            gemini_api_key: execGeminiKey,
            anthropic_api_key: execAnthropicKey,
            ollama_api_url: execOllamaUrl,
            max_steps: parseInt(maxSteps.value),
            summarization_threshold: parseInt(summarizationThreshold.value),
            llm_timeout: parseInt(llmTimeout.value),
            chat_history_message_count: parseInt(chatHistoryCount.value),
            // Chat LLM Configuration (always save, enabled=true)
            chat_llm: {
                enabled: true,  // Always enabled in dual config mode
                provider: chatProvider,
                model_name: chatModel,
                api_key: chatApiKey
            }
        };

        fetch('/save_agent_config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(config)
        }).then(res => res.json()).then(data => {
            if (data.status === 'success') {
                closeModal('agent');
                updateAgentTriggerStatus();
            } else {
                alert('Error: ' + data.message);
            }
        });
    });

    // System Configuration
    const systemIp = document.getElementById('system-ip');
    const systemUsername = document.getElementById('system-username');
    const sshPort = document.getElementById('ssh-port');
    const sshKeyPath = document.getElementById('ssh-key-path');
    const saveSystemBtn = document.getElementById('save-system-btn');
    const systemSummary = document.getElementById('system-summary');
    const savedConnectionsSelect = document.getElementById('saved-connections-select');
    const loadConnectionBtn = document.getElementById('load-connection-btn');
    const deleteConnectionBtn = document.getElementById('delete-connection-btn');
    const deploymentPassword = document.getElementById('deployment-password');
    const deployKeyBtn = document.getElementById('deploy-key-btn');
    const deployLogArea = document.getElementById('deploy-log-area');
    const deployLogTextarea = document.getElementById('deploy-log-textarea');
    const deploymentStatus = document.getElementById('deployment-status');

    systemTrigger.addEventListener('click', function() {
        if(this.classList.contains('disabled')) return;
        fetch('/get_system_config').then(res => res.json()).then(data => {
            systemIp.value = data.ip_address;
            systemUsername.value = data.username;
            sshKeyPath.value = data.ssh_key_path;
            savedConnectionsSelect.innerHTML = '';
            if (data.saved_connections && data.saved_connections.length > 0) {
                data.saved_connections.forEach(conn => {
                    const opt = new Option(`${conn.username}@${conn.ip}`, JSON.stringify(conn));
                    savedConnectionsSelect.appendChild(opt);
                });
            } else {
                savedConnectionsSelect.appendChild(new Option('-- No saved connections --', ''));
            }
        }).catch(e => console.error('Error loading system config:', e));
        openModal('system');
    });

    loadConnectionBtn.addEventListener('click', function() {
        const selectedValue = savedConnectionsSelect.value;
        if (selectedValue && selectedValue !== '') {
            try {
                const conn = JSON.parse(selectedValue);
                systemIp.value = conn.ip;
                systemUsername.value = conn.username;
                sshPort.value = conn.port || 22;
                sshKeyPath.value = conn.ssh_key_path || '/app/keys/id_rsa';
            } catch (e) {
                console.error('Error loading connection:', e);
            }
        }
    });

    deleteConnectionBtn.addEventListener('click', function() {
        const selectedValue = savedConnectionsSelect.value;
        if (selectedValue && selectedValue !== '') {
            try {
                const conn = JSON.parse(selectedValue);
                if (confirm(`Delete connection ${conn.username}@${conn.ip}?`)) {
                    fetch('/delete_connection', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ip: conn.ip, username: conn.username})
                    }).then(res => res.json()).then(data => {
                        if (data.status === 'success') {
                            const selectedOption = savedConnectionsSelect.querySelector('option:checked');
                            if (selectedOption) selectedOption.remove();
                            if (savedConnectionsSelect.options.length === 0) {
                                savedConnectionsSelect.appendChild(new Option('-- No saved connections --', ''));
                            }
                        }
                    });
                }
            } catch (e) {
                console.error('Error deleting connection:', e);
            }
        }
    });

    deployKeyBtn.addEventListener('click', function() {
        const pwd = deploymentPassword.value;
        if (!pwd) {
            alert('Please enter the password for key deployment.');
            return;
        }
        if (!systemIp.value || !systemUsername.value) {
            alert('Please enter System IP and Username first.');
            return;
        }
        
        deployLogArea.style.display = 'block';
        deployLogTextarea.value = 'Starting key deployment...\n';
        deploymentStatus.textContent = 'Deploying...';
        deploymentStatus.className = 'status-label';
        
        fetch('/deploy_ssh_key', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                ip: systemIp.value,
                username: systemUsername.value,
                password: pwd
            })
        }).then(res => res.json()).then(data => {
            if (data.status === 'success') {
                deploymentStatus.textContent = 'âœ“ Key deployed successfully';
                deploymentStatus.className = 'status-label success';
                deployLogTextarea.value += 'Key deployment successful!\n';
                deploymentPassword.value = '';
            } else {
                deploymentStatus.textContent = 'âœ— Deployment failed';
                deploymentStatus.className = 'status-label failure';
                deployLogTextarea.value += `Deployment failed: ${data.message}\n`;
            }
        }).catch(e => {
            deploymentStatus.textContent = 'âœ— Deployment error';
            deploymentStatus.className = 'status-label failure';
            deployLogTextarea.value += `Error: ${e}\n`;
        });
    });

    socket.on('deploy_log', (data) => {
        if (deployLogTextarea) {
            deployLogTextarea.value += data.data;
            deployLogTextarea.scrollTop = deployLogTextarea.scrollHeight;
        }
    });

    saveSystemBtn.addEventListener('click', function() {
        const config = {
            ip_address: systemIp.value,
            username: systemUsername.value,
            ssh_port: parseInt(sshPort.value) || 22,
            ssh_key_path: sshKeyPath.value || '/app/keys/id_rsa'
        };
        
        fetch('/save_system_config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(config)
        }).then(res => res.json()).then(data => {
            if (data.status === 'success') {
                closeModal('system');
                updateSystemTriggerStatus();
            } else {
                alert('Error: ' + data.message);
            }
        });
    });

    // Prompt editor logic
    const standardModeBtn = document.getElementById('standard-mode-btn');
    const askModeBtn = document.getElementById('ask-mode-btn');
    const chatModeBtn = document.getElementById('chat-mode-btn');

    const executionPromptsContainer = document.getElementById('execution-prompts-container');
    const chatPromptContainer = document.getElementById('chat-prompt-container');

    const ollamaPromptTextarea = document.getElementById('ollama-prompt-textarea');
    const cloudPromptTextarea = document.getElementById('cloud-prompt-textarea');
    const chatPromptTextarea = document.getElementById('chat-prompt-textarea');

    const savePromptsBtn = document.getElementById('save-prompts-btn');
    const promptValidationStatus = document.getElementById('prompt-validation-status');
    const promptValidationNote = document.getElementById('prompt-validation-note');
    let currentPromptMode = 'standard';

    function setPromptModeUI(mode) {
        currentPromptMode = mode;

        // Reset buttons
        standardModeBtn.style.backgroundColor = '#5c5c5c';
        askModeBtn.style.backgroundColor = '#5c5c5c';
        chatModeBtn.style.backgroundColor = '#5c5c5c';

        // Set Active
        if(mode === 'standard') standardModeBtn.style.backgroundColor = '#0e639c';
        if(mode === 'ask') askModeBtn.style.backgroundColor = '#0e639c';
        if(mode === 'chat') chatModeBtn.style.backgroundColor = '#0e639c';

        // Toggle Containers & Notes
        if (mode === 'chat') {
            executionPromptsContainer.style.display = 'none';
            chatPromptContainer.style.display = 'flex';
            promptValidationNote.innerHTML = 'Required variable: <code>{user_message}</code><br>Optional: <code>{history}</code>, <code>{objective}</code>, <code>{system_info}</code>';
        } else {
            executionPromptsContainer.style.display = 'flex';
            chatPromptContainer.style.display = 'none';
            let keywords = '<code>COMMAND:</code>, <code>REPORT:</code>';
            if (mode === 'ask') keywords += ', <code>ASK:</code>';
            promptValidationNote.innerHTML = `Required variables: <code>{objective}</code>, <code>{history}</code>, <code>{system_info}</code><br>Required keywords: ${keywords}`;
        }
    }

    promptEditorTrigger.addEventListener('click', function() {
        setPromptModeUI('standard');
        loadPrompts('standard');
        openModal('prompt-editor');
    });

    // Prompts Import/Export Modal
    promptsIoTrigger.addEventListener('click', function() {
        openModal('prompts-io');
    });

    const exportPromptsBtn = document.getElementById('export-prompts-btn');
    const importPromptsBtn = document.getElementById('import-prompts-btn');
    const importPromptsFile = document.getElementById('import-prompts-file');
    const promptsIoStatus = document.getElementById('prompts-io-status');
    const promptsIoStatusText = document.getElementById('prompts-io-status-text');

    function showPromptsIoStatus(message, isError = false) {
        promptsIoStatus.style.display = 'block';
        promptsIoStatus.style.backgroundColor = isError ? '#c0392b' : '#27ae60';
        promptsIoStatus.style.border = `1px solid ${isError ? '#e74c3c' : '#2ecc71'}`;
        promptsIoStatusText.textContent = message;

        // Auto-hide after 5 seconds
        setTimeout(() => {
            promptsIoStatus.style.display = 'none';
        }, 5000);
    }

    exportPromptsBtn.addEventListener('click', function() {
        // Trigger download by navigating to export endpoint
        window.location.href = '/export_prompts';
        showPromptsIoStatus('Export started! Download should begin shortly.');
    });

    importPromptsBtn.addEventListener('click', function() {
        const file = importPromptsFile.files[0];

        if (!file) {
            showPromptsIoStatus('Please select a ZIP file first.', true);
            return;
        }

        if (!file.name.endsWith('.zip')) {
            showPromptsIoStatus('File must be a ZIP archive.', true);
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        promptsIoStatusText.textContent = 'Importing prompts...';
        promptsIoStatus.style.display = 'block';
        promptsIoStatus.style.backgroundColor = '#3498db';
        promptsIoStatus.style.border = '1px solid #5dade2';

        fetch('/import_prompts', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                showPromptsIoStatus(data.message);
                // Clear file input
                importPromptsFile.value = '';
            } else {
                showPromptsIoStatus(data.message, true);
            }
        })
        .catch(err => {
            showPromptsIoStatus('Error importing prompts: ' + err.message, true);
        });
    });

    standardModeBtn.addEventListener('click', function() {
        setPromptModeUI('standard');
        loadPrompts('standard');
    });

    askModeBtn.addEventListener('click', function() {
        setPromptModeUI('ask');
        loadPrompts('ask');
    });

    chatModeBtn.addEventListener('click', function() {
        setPromptModeUI('chat');
        loadPrompts('chat');
    });

    function loadPrompts(mode) {
        fetch(`/get_prompts?mode=${mode}`).then(res => res.json()).then(data => {
            if (mode === 'chat') {
                chatPromptTextarea.value = data.chat_prompt || '';
            } else {
                ollamaPromptTextarea.value = data.ollama_prompt || '';
                cloudPromptTextarea.value = data.cloud_prompt || '';
            }
        });
    }

    savePromptsBtn.addEventListener('click', function() {
        promptValidationStatus.textContent = 'Saving...';

        const payload = new URLSearchParams();
        payload.append('mode', currentPromptMode);

        if (currentPromptMode === 'chat') {
            payload.append('chat_prompt', chatPromptTextarea.value);
        } else {
            payload.append('ollama_prompt', ollamaPromptTextarea.value);
            payload.append('cloud_prompt', cloudPromptTextarea.value);
        }

        fetch('/save_prompts', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: payload
        }).then(res => res.json()).then(data => {
            if (data.status === 'success') {
                promptValidationStatus.textContent = 'âœ“ Saved';
                setTimeout(() => {
                    promptValidationStatus.textContent = '';
                    closeModal('prompt-editor');
                }, 1000);
            } else {
                promptValidationStatus.textContent = `âœ— ${data.message}`;
            }
        });
    });

    // Summarization prompt logic
    const ollamaSummarizeTextarea = document.getElementById('ollama-summarize-prompt-textarea');
    const cloudSummarizeTextarea = document.getElementById('cloud-summarize-prompt-textarea');
    const ollamaStepTextarea = document.getElementById('ollama-step-prompt-textarea');
    const cloudStepTextarea = document.getElementById('cloud-step-prompt-textarea');
    const ollamaSearchTextarea = document.getElementById('ollama-search-prompt-textarea');
    const cloudSearchTextarea = document.getElementById('cloud-search-prompt-textarea');
    const saveSummarizationPromptsBtn = document.getElementById('save-summarization-prompts-btn');
    const summarizationValidationStatus = document.getElementById('summarization-validation-status');

    // New toggle elements
    const sumHistoryModeBtn = document.getElementById('sum-history-mode-btn');
    const sumStepModeBtn = document.getElementById('sum-step-mode-btn');
    const sumSearchModeBtn = document.getElementById('sum-search-mode-btn');
    const sumHistoryContainer = document.getElementById('sum-history-container');
    const sumStepContainer = document.getElementById('sum-step-container');
    const sumSearchContainer = document.getElementById('sum-search-container');

    // Toggle Logic
    sumHistoryModeBtn.addEventListener('click', () => {
        sumHistoryModeBtn.style.backgroundColor = '#0e639c';
        sumStepModeBtn.style.backgroundColor = '#5c5c5c';
        sumSearchModeBtn.style.backgroundColor = '#5c5c5c';
        sumHistoryContainer.style.display = 'flex';
        sumStepContainer.style.display = 'none';
        sumSearchContainer.style.display = 'none';
    });

    sumStepModeBtn.addEventListener('click', () => {
        sumStepModeBtn.style.backgroundColor = '#0e639c';
        sumHistoryModeBtn.style.backgroundColor = '#5c5c5c';
        sumSearchModeBtn.style.backgroundColor = '#5c5c5c';
        sumStepContainer.style.display = 'flex';
        sumHistoryContainer.style.display = 'none';
        sumSearchContainer.style.display = 'none';
    });

    sumSearchModeBtn.addEventListener('click', () => {
        sumSearchModeBtn.style.backgroundColor = '#0e639c';
        sumHistoryModeBtn.style.backgroundColor = '#5c5c5c';
        sumStepModeBtn.style.backgroundColor = '#5c5c5c';
        sumSearchContainer.style.display = 'flex';
        sumHistoryContainer.style.display = 'none';
        sumStepContainer.style.display = 'none';
    });

    summarizationTrigger.addEventListener('click', function() {
        // Reset to History view
        sumHistoryModeBtn.click();

        fetch('/get_summarization_prompt').then(res => res.json()).then(data => {
            ollamaSummarizeTextarea.value = data.ollama_summarize_prompt || '';
            cloudSummarizeTextarea.value = data.cloud_summarize_prompt || '';
            ollamaStepTextarea.value = data.ollama_step_prompt || '';
            cloudStepTextarea.value = data.cloud_step_prompt || '';
            ollamaSearchTextarea.value = data.ollama_search_prompt || '';
            cloudSearchTextarea.value = data.cloud_search_prompt || '';
        });
        openModal('summarization-prompt');
    });

    saveSummarizationPromptsBtn.addEventListener('click', function() {
        summarizationValidationStatus.textContent = 'Validating...';
        fetch('/save_summarization_prompt', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: new URLSearchParams({
                ollama_summarize_prompt: ollamaSummarizeTextarea.value,
                cloud_summarize_prompt: cloudSummarizeTextarea.value,
                ollama_step_prompt: ollamaStepTextarea.value,
                cloud_step_prompt: cloudStepTextarea.value,
                ollama_search_prompt: ollamaSearchTextarea.value,
                cloud_search_prompt: cloudSearchTextarea.value
            })
        }).then(res => res.json()).then(data => {
            if (data.status === 'success') {
                summarizationValidationStatus.textContent = 'âœ“ Saved successfully';
                setTimeout(() => {
                    summarizationValidationStatus.textContent = '';
                    closeModal('summarization-prompt');
                }, 1500);
            } else {
                summarizationValidationStatus.textContent = `âœ— ${data.message}`;
            }
        });
    });

    // Validator prompt logic
    const ollamaValidatorTextarea = document.getElementById('ollama-validator-prompt-textarea');
    const cloudValidatorTextarea = document.getElementById('cloud-validator-prompt-textarea');
    const saveValidatorPromptsBtn = document.getElementById('save-validator-prompts-btn');
    const validatorValidationStatus = document.getElementById('validator-validation-status');

    validatorTrigger.addEventListener('click', function() {
        fetch('/get_validator_prompt').then(res => res.json()).then(data => {
            ollamaValidatorTextarea.value = data.ollama_validator_prompt || '';
            cloudValidatorTextarea.value = data.cloud_validator_prompt || '';
        });
        openModal('validator-prompt');
    });

    saveValidatorPromptsBtn.addEventListener('click', function() {
        validatorValidationStatus.textContent = 'Validating...';
        fetch('/save_validator_prompt', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: new URLSearchParams({
                ollama_validator_prompt: ollamaValidatorTextarea.value,
                cloud_validator_prompt: cloudValidatorTextarea.value
            })
        }).then(res => res.json()).then(data => {
            if (data.status === 'success') {
                validatorValidationStatus.textContent = 'âœ“ Saved successfully';
                setTimeout(() => {
                    validatorValidationStatus.textContent = '';
                    closeModal('validator-prompt');
                }, 1500);
            } else {
                validatorValidationStatus.textContent = `âœ— ${data.message}`;
            }
        });
    });

    // Manual summarize logic
    manualSummarizeTrigger.addEventListener('click', function() {
        if(this.classList.contains('disabled')) {
            alert('Please configure and test LLM connection first.');
            return;
        }
        if(confirm('Manually summarize the agent history using LLM?')) {
            socket.emit('manual_summarize');
        }
    });

    function updateHistoryCharCount() {
        fetch('/get_history_stats').then(res => res.json()).then(data => {
            const charCountEl = document.getElementById('history-char-count');
            if(charCountEl) {
                charCountEl.textContent = `${data.char_count} chars`;
            }
        });
    }

    function updateAgentTriggerStatus() {
        // Fetch both LLM status and agent config for dual-model display
        Promise.all([
            fetch('/get_llm_status').then(res => res.json()),
            fetch('/get_agent_config').then(res => res.json())
        ]).then(([statusData, configData]) => {
            // Update manual summarize trigger based on status
            const isSuccess = statusData.status === 'success';
            if(manualSummarizeTrigger) {
                if(isSuccess) {
                    manualSummarizeTrigger.classList.remove('disabled');
                } else {
                    manualSummarizeTrigger.classList.add('disabled');
                }
            }

            // Update dual-model info display
            const lblExec = document.getElementById('lbl-exec-info');
            const lblChat = document.getElementById('lbl-chat-info');

            if (lblExec && lblChat) {
                // 1. EXEC Info
                let execProvider = configData.provider || 'Unknown';
                let execModel = configData.model_name || 'Default';
                // Clean path like 'models/gemini-pro' -> 'gemini-pro'
                if (execModel.includes('/')) execModel = execModel.split('/').pop();

                // Format: Exec: Provider (Model)
                lblExec.innerHTML = `<span style="color:#4CAF50; font-weight:bold;">Exec:</span> ${execProvider} <span style="opacity:0.7">(${execModel})</span>`;

                // 2. CHAT Info
                if (configData.chat_llm && configData.chat_llm.enabled) {
                    let chatProvider = configData.chat_llm.provider || execProvider;
                    let chatModel = configData.chat_llm.model_name || execModel;
                    if (chatModel.includes('/')) chatModel = chatModel.split('/').pop();

                    lblChat.innerHTML = `<span style="color:#2196F3; font-weight:bold;">Chat:</span> ${chatProvider} <span style="opacity:0.7">(${chatModel})</span>`;
                } else {
                    lblChat.innerHTML = `<span style="color:#666;">Chat: (Same as Exec)</span>`;
                }
            }
        }).catch(err => {
            console.error('Error updating agent trigger status:', err);
        });
    }

    function updateSystemTriggerStatus() {
        fetch('/get_ssh_status').then(res => res.json()).then(data => {
            systemTrigger.className = 'config-chip ' + data.status;
            systemSummary.textContent = data.message;
        });
    }

    socket.on('llm_status_update', (data) => {
        // Update full agent trigger with dual-model display
        updateAgentTriggerStatus();
    });

    socket.on('ssh_status_update', (data) => {
        systemTrigger.className = 'config-chip ' + data.status;
        systemSummary.textContent = data.message;
    });

    socket.on('update_history', () => {
        updateHistoryCharCount();
    });

    socket.on('awaiting_command_approval', (data) => {
        document.getElementById('command-reason').innerText = data.reason || 'No reason provided';
        document.getElementById('command-to-approve').value = data.command || '';
        openModal('approval');
    });

    socket.on('awaiting_user_answer', (data) => {
        document.getElementById('ask-reason-text').innerText = data.reason || 'No reason provided';
        document.getElementById('ask-question-text').innerText = data.question || 'No question provided';
        document.getElementById('ask-objective-textarea').value = data.objective || '';
        openModal('ask');
    });

    socket.on('request_history_summarization', (data) => {
        // Use enhanced modal with threshold option
        const currentHistoryChars = document.getElementById('current-history-chars');
        const currentThresholdDisplay = document.getElementById('current-threshold-display');
        const newThresholdInput = document.getElementById('new-threshold-input');
        
        currentHistoryChars.textContent = data.current_length || '0';
        currentThresholdDisplay.textContent = data.current_threshold || '15000';
        newThresholdInput.value = data.current_threshold || '15000';
        
        openModal('summarization-decision');
    });

    const currentPath = window.location.pathname;
    const navLive = document.getElementById('nav-live');
    const navHistory = document.getElementById('nav-history');
    if(navLive && navHistory) {
        if(currentPath === '/history') {
            navHistory.classList.add('active');
            navLive.classList.remove('active');
        } else {
            navLive.classList.add('active');
            navHistory.classList.remove('active');
        }
    }

    loadSessionInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const formData = new FormData();
        formData.append('file', file);
        
        fetch('/load_session', {
            method: 'POST',
            body: formData
        }).then(res => res.json()).then(data => {
            if (data.status === 'success') {
                alert('Session loaded successfully!');
                location.reload();
            } else {
                alert('Error loading session: ' + data.message);
            }
        }).catch(e => {
            alert('Error uploading file: ' + e);
        });
        
        this.value = '';
    });

    updateHistoryCharCount();
    updateAgentTriggerStatus();
    updateSystemTriggerStatus();
});
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>
